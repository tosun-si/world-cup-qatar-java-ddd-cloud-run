options:
  machineType: "E2_HIGHCPU_32"
steps:
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: bash
    args:
      - -c
      - |
        echo "############# Build and publish the Dockerfile $_SERVICE_NAME_NATIVE_GRAAL_VM"

        docker buildx create --use --driver docker-container
        
        IMAGE_PATH="$LOCATION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_SERVICE_NAME_NATIVE_GRAAL_VM:$_IMAGE_TAG"
        CACHE_IMAGE="$LOCATION-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_SERVICE_NAME_NATIVE_GRAAL_VM:cache"
        
        docker buildx build \
          -f cicd/native-graalvm/Dockerfile \
          -t $$IMAGE_PATH \
          --push \
          --cache-from=type=registry,ref=$$CACHE_IMAGE \
          --cache-to=type=registry,ref=$$CACHE_IMAGE,mode=max .
